---
- name: "STEP 1: WEAPONRY - Install Core CLI & Virtualization Tools"
  ansible.builtin.dnf:
    name:
      - zoxide        # Smart navigation
      - fzf           # Fuzzy finder
      - eza           # High-density ls replacement
      - bat           # Cat with wings (syntax highlighting)
      - neovim        # Editor of choice
      - docker-ce
      - docker-ce-cli
      - containerd.io
      - docker-buildx-plugin
      - docker-compose-plugin
      - libvirt       # KVM Management
      - virt-manager  # KVM GUI
      - timeshift     # Resilience/Snapshots
      - keepassxc     # Offline AES-256 Sovereignty
    state: present
    update_cache: yes
  tags: [core, packages]

- name: "STEP 1.1: Ensure Virtualization Services are Active"
  ansible.builtin.service:
    name: "{{ item }}"
    state: started
    enabled: yes
  loop:
    - docker
    - libvirtd
  tags: [core, services]

- name: "STEP 2: ALIAS DOCTRINE - Inject Operational Shortcuts"
  ansible.builtin.blockinfile:
    path: "{{ ansible_env.HOME }}/.bashrc"
    marker: "# {mark} ANSIBLE MANAGED: TITAN ALIAS DOCTRINE"
    block: |
      # Titan Operational Aliases
      alias update='sudo dnf update -y && flatpak update -y'
      alias clean='sudo dnf autoremove -y && flatpak uninstall --unused'
      alias gc='git commit -S -m'
      alias ll='eza --icons --long --git'
      
      # Tool Initialization
      eval "$(zoxide init bash)"
  tags: [config, shell]

- name: "STEP 3: DEFENSE - Configure Firewall (Deny All Inbound)"
  ansible.posix.firewalld:
    zone: public
    state: enabled
    permanent: yes
    target: DROP  # The "Black Hole" strategy
  notify: Restart Firewalld
  tags: [security, firewall]

- name: "STEP 4: IDENTITY - Enforce GPG Signing (Non-Repudiation)"
  community.general.git_config:
    name: commit.gpgsign
    scope: global
    value: "true"
  tags: [security, identity]
